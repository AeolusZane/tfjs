<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆ©ç”¨å·ç§¯ç¥ç»ç½‘ç»œç®—æ³•è¯†åˆ«è½¦logo</title>
  </head>
  <body>
    <img
      src="https://img0.baidu.com/it/u=925926280,2863725&fm=253&fmt=auto&app=138&f=GIF?w=564&h=500"
      id="some_image"
      crossorigin="anonymous"
      width="300px"
    />
    <input type="button" value="è¯†åˆ«" id="test" />
    <script src="./net/car.js"></script>
    <script src="./net/convnet.js"></script>
    <script type="text/javascript">
      /*
       *1.å·ç§¯å±‚ ï¼šæå–å›¾åƒç‰¹å¾ æ± åŒ–å±‚ï¼šç‰¹å¾ç¼©å° é™ç»´ é˜²æ­¢è¿‡æ‹Ÿåˆ
       *2.å…¨è¿æ¥å±‚ï¼šåˆ†ç±»
       *3.æ»¤æ³¢å™¨ï¼ˆå·ç§¯æ ¸ï¼‰https://setosa.io/ev/image-kernels/
              * https://cs231n.github.io/convolutional-networks/ å¦‚ä½•å·ç§¯
            æ»¤æ³¢å™¨ 3*3 å¥—åœ¨å›¾åƒä¸Šè¿›è¡Œæˆç»©æ±‚å’Œ æ›¿æ¢ä½äºæ»¤æ³¢å™¨ä¸­å¿ƒå€¼
       *4.å…¸å‹CNN å·ç§¯-æ± åŒ–-å·ç§¯-æ± åŒ–-å…¨è¿æ¥-å…¨è¿æ¥-å…¨è¿æ¥
       *5.æœºå™¨ä¼šä¸ºæ¯”è¾ƒé‡è¦çš„æ»¤æ³¢å™¨èµ‹äºˆè¾ƒé«˜çš„æƒé™ ä»è€Œæé«˜æ»¤æ³¢å™¨çš„å™¨çš„æ•ˆæœ
       *6.æ± åŒ–å±‚ç®—æ³•é€šå¸¸ä¼˜ä¸¤å¤§ç±»ï¼šå–å‡å€¼ã€å–æœ€å¤§å€¼ è¿è¡Œçš„æ­¥é•¿æœ€å¥½æ˜¯æ»¤æ³¢å™¨çš„å¤§å°
       */
      //ç¥ç»ç½‘ç»œ
      let layer_defs = [];
      //è¾“å…¥å±‚ 100*100*3
      layer_defs.push({
        type: 'input',
        out_sx: 100,
        out_sy: 100,
        out_depth: 3,
      });
      //å·ç§¯å±‚
      //filter+sx:å¤šå°‘ä¸ªæ»¤æ³¢å™¨ ç”¨16ä¸ª5*5çš„æ»¤æ³¢å™¨å»å·ç§¯
      //stride:æ­¥é•¿
      //padding:å¡«å……
      //activation:æ¿€æ´»å‡½æ•° relu(è¿˜æœ‰æœ‰Tanhã€Sigmoidç­‰ç­‰å‡½æ•°)
      layer_defs.push({
        type: 'conv',
        sx: 5,
        filters: 16,
        stride: 1,
        pad: 2,
        activation: 'relu',
      });
      //æ± åŒ–å±‚
      //æ± åŒ–å±‚çš„æ»¤æ³¢å™¨ å¤§å°ä¸º2*2
      //strideæ­¥é•¿2
      //å†…éƒ¨æ— æ³•çœ‹åˆ°ä»–æ˜¯ä½¿ç”¨å¹³å‡å€¼ è¿˜æ˜¯ä½¿ç”¨æœ€å¤§å€¼ã€ä»€ä¹ˆç±»å‹æ»¤æ³¢å™¨
      layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
      //åå¤çš„å·ç§¯æ± åŒ–
      layer_defs.push({
        type: 'conv',
        sx: 5,
        filters: 16,
        stride: 1,
        pad: 2,
        activation: 'relu',
      });
      layer_defs.push({ type: 'pool', sx: 2, stride: 2 });
      //åˆ†ç±»å™¨ è¾“å‡º10ä¸­ç±»åˆ«
      layer_defs.push({
        type: 'softmax',
        num_classes: 10,
      });
      //åˆå§‹åŒ–ç¥ç»ç½‘ç»œ
      const net = new convnetjs.Net();
      net.makeLayers(layer_defs);
      //è®­ç»ƒ
      //   {
      //       data: train_x,
      //       labels: train_y,
      //       //è®­ç»ƒæ¬¡æ•°
      //       //iterations: 100,
      //       //å­¦ä¹ ç‡
      //       //learning_rate: 0.01,
      //       //è®­ç»ƒæ—¶é—´
      //       //timeout: 100,
      //       //è®­ç»ƒè¿‡ç¨‹ä¸­çš„å›è°ƒå‡½æ•°
      //       //callback: function(e) {
      //       //  console.log(e);
      //       //},
      //     },
      //     {
      //       //è®­ç»ƒæ¬¡æ•°
      //       //iterations: 100,
      //       //å­¦ä¹ ç‡
      //       //learning_rate: 0.01,
      //       //è®­ç»ƒæ—¶é—´
      //       //timeout: 100,
      //       //è®­ç»ƒè¿‡ç¨‹ä¸­çš„å›è°ƒå‡½æ•°
      //       //callback: function(e) {
      //       //  console.log(e);
      //       //},
      //     }
      //éšæœºæ¢¯åº¦ä¸‹é™
      const trainer = new convnetjs.SGDTrainer(net, {
        //å­¦ä¹ ç‡
        learning_rate: 0.01,
        //åŠ é€Ÿæ¢¯åº¦ä¸‹é™ ä¼˜åŒ–å™¨
        momentum: 0.1,
        batch_size: 5,
        l2_decay: 0.0,
      });

      let imageList = [];
      const loadData = (i) => {
        return function () {
          return new Promise(function (resolve, reject) {
            let image = new Image();
            image.crossOrigin = 'anonymous';
            image.src = carList[i].url;
            image.onload = function () {
              //æŠŠå›¾ç‰‡çŸ¢é‡åŒ–
              let vol = convnetjs.img_to_vol(image);
              //åŠ è½½æˆåŠŸä¸€æ¬¡è®­ç»ƒä¸€æ¬¡
              trainer.train(vol, i);
              resolve();
            };
            image.onerror = reject;
          });
        };
      };
      for (let j = 0; j < carList.length; j++) {
        imageList.push(loadData(j));
      }
      var testBtn = document.getElementById('test');
      function training() {
        testBtn.disabled = true;
        return new Promise((resolve, reject) => {
          Promise.all(imageList.map((imageContainer) => imageContainer())).then(
            () => {
              console.log('æ¨¡å‹è®­ç»ƒå¥½äº†ï¼ï¼ï¼ğŸ‘Œ');
              testBtn.disabled = false;
              resolve();
            }
          );
        });
      }
      training().then(() => {
        testBtn.addEventListener('click', () => {
          // å‘Šè¯‰æœºå™¨æ¯ä¸€ç±»å¯¹åº”çš„æ˜¯ä»€ä¹ˆï¼ˆå³è®©æœºå™¨è®¤è¯†å›¾ç‰‡çš„è¿‡ç¨‹ï¼‰
          const carNameList = [
            'å¥¥è¿ª',
            'å¥”é©°',
            'å®é©¬',
            'æœ¬ç”°',
            'åˆ«å…‹',
            'æ¯”äºšè¿ª',
            'ä¿æ—¶æ·',
            'å¤§ä¼—',
            'å“ˆå¼—',
          ];
          //è¾“å…¥ é¡µé¢ä¸­è¿™å¼ img è½¬åŒ–æˆçŸ¢é‡å¹¶ä¸”è¿›è¡Œå½’ä¸€åŒ–æ“ä½œ
          const x = convnetjs.img_to_vol(document.getElementById('some_image'));
          // console.log(net.forward(x));
          //å–åˆ°æœ€æœ‰å¯èƒ½æ€§çš„ç±»åˆ«
          const result = Array.from(net.forward(x).w);
          let max = Math.max.apply(Math, result);
          console.log(
            'æœ€æœ‰å¯èƒ½çš„é‚£ä¸ªæ±½è½¦logoğŸš—',
            carNameList[result.indexOf(max)]
          );
          console.log('æ¥ç€è®­ç»ƒï¼ï¼ï¼ğŸ’ª');
          training();
        });
      });
    </script>
  </body>
</html>
